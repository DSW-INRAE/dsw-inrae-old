{#- Macros -#}

{#- Cette fonction permet de traverser r√©cursivement les question -#}

{%- macro markQuestions(replyPathUuids, question, questionString) -%}

    {%- if question["questionType"] == "ListQuestion" -%}

        {%- set reply = repliesMap[replyPathUuids | reply_path]["value"] -%}
        {%- set k = namespace(value=0) -%}

        {%- for questionUuid in reply["value"] -%}

            {%- set l = namespace(value=1) -%}

            {%- for subQuestionUuid in question["itemTemplateQuestionUuids"] -%}
                {%- set subQuestion = km.entities.questions[subQuestionUuid] -%}
                {{- replyPathUuids.append(questionUuid) or ""-}}
                {{- replyPathUuids.append(subQuestionUuid) or ""-}}


                {{- markQuestions(replyPathUuids, subQuestion, questionString + "." + k.value|of_alphabet + "." + l.value|string) -}}

                {{- replyPathUuids.remove(questionUuid) or ""-}}
                {{- replyPathUuids.remove(subQuestionUuid) or ""-}}

                {%- set l.value = l.value + 1 -%}
            {%- endfor -%}

            {%- set k.value = k.value + 1 -%}
        {%- endfor -%}

    {%- else -%}
            {{- questionString -}};
    {%- endif -%}
{%- endmacro %}

{#- Body of the script -#}

{%- set km = ctx.knowledgeModel -%}
{%- set repliesMap = ctx.questionnaireReplies -%}

{%- set i = namespace(value=1) -%}

{%- for chapterUuid in km.entities.chapters -%}

    {% set j = namespace(value=1) %}

    {%- for questionUuid in km.entities.chapters[chapterUuid].questionUuids -%}

        {%- set question = km.entities.questions[questionUuid] -%}

        {{- markQuestions([chapterUuid, questionUuid], question, "q" + i.value|string + "." + j.value|string) -}}

        {%- set j.value = j.value + 1 -%}
    {%- endfor -%}

    {% set i.value = i.value + 1 %}
{%- endfor -%}

{{- "\n" -}}

{%- for chapterUuid in km.entities.chapters -%}
    {%- for questionUuid in km.entities.chapters[chapterUuid].questionUuids -%}

        {%- set reply = repliesMap[[chapterUuid, questionUuid] | reply_path]["value"] -%}

        {%- if reply["type"] == "StringReply" -%}
            {{- reply["value"] -}};
        {%- elif reply["type"] == "AnswerReply" -%}
                        {{- reply["value"] | reply_str_value -}}
            {{- km["entities"]["answers"][reply["value"]]["label"] -}};
        {%- elif reply["type"] == "MultiChoiceReply" -%}
        {%- elif reply["type"] == "ItemListReply" -%}

        {%- endif -%}

    {%- endfor -%}
{%- endfor -%}
