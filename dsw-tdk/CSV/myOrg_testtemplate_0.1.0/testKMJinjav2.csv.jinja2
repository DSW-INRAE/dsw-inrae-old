{#- Macros -#}

{#- Cette fonction permet de traverser r√©cursivement les question -#}

{%- macro markQuestions(replyPathUuids, question, questionString) -%}

    {%- if question["questionType"] == "ListQuestion" -%}

        {%- set reply = repliesMap[replyPathUuids | reply_path]["value"] -%}
        {%- set k = namespace(value = 0) -%}

        {%- for questionUuid in reply["value"] -%}

            {%- set l = namespace(value = 1) -%}

            {%- for subQuestionUuid in question["itemTemplateQuestionUuids"] -%}
                {%- set subQuestion = km.entities.questions[subQuestionUuid] -%}
                {{- replyPathUuids.append(questionUuid) or "" -}}
                {{- replyPathUuids.append(subQuestionUuid) or "" -}}

                {{- markQuestions(replyPathUuids, subQuestion, questionString + "." + k.value | of_alphabet + "." + l.value | string) -}}

                {{- replyPathUuids.remove(questionUuid) or "" -}}
                {{- replyPathUuids.remove(subQuestionUuid) or "" -}}

                {%- set l.value = l.value + 1 -%}
            {%- endfor -%}

            {%- set k.value = k.value + 1 -%}
        {%- endfor -%}
    {%- elif question["questionType"] == "OptionsQuestion" -%}
        {{- "\"" + questionString + "\"" + "," -}}
        {%- set reply = repliesMap[replyPathUuids | reply_path]["value"] -%}

        {%- set answerUuid = reply["value"] -%}

        {%- set followUpUuids = km.entities.answers[answerUuid].followUpUuids -%}

        {%- set k = namespace(value = 1) -%}

        {%- for followUpUuid in followUpUuids -%}
            {%- set subQuestion = km.entities.questions[followUpUuid] -%}

            {{- replyPathUuids.append(answerUuid) or "" -}}
            {{- replyPathUuids.append(followUpUuid) or "" -}}

            {{- markQuestions(replyPathUuids, subQuestion, questionString + "." + 0 | of_alphabet + "." + k.value | string) -}}

            {{- replyPathUuids.remove(answerUuid) or "" -}}
            {{- replyPathUuids.remove(followUpUuid) or "" -}}

            {%- set k.value = k.value + 1 -%}
        {%- endfor -%}
    {%- else -%}
        {{- "\"" + questionString + "\"" + ","-}}
    {%- endif -%}
{%- endmacro %}

{%- macro valuesOfQuestions(replyPathUuids, question) -%}
    {%- set reply = repliesMap[replyPathUuids | reply_path]["value"] -%}

    {%- if question["questionType"] == "ListQuestion" -%}
        {%- for questionUuid in reply["value"] -%}
            {%- for subQuestionUuid in question["itemTemplateQuestionUuids"] -%}

                {%- set subQuestion = km.entities.questions[subQuestionUuid] -%}
                {{- replyPathUuids.append(questionUuid) or "" -}}
                {{- replyPathUuids.append(subQuestionUuid) or "" -}}

                {{- valuesOfQuestions(replyPathUuids, subQuestion) -}}

                {{- replyPathUuids.remove(questionUuid) or "" -}}
                {{- replyPathUuids.remove(subQuestionUuid) or "" -}}

            {%- endfor -%}
        {%- endfor -%}
    {%- elif question["questionType"] == "OptionsQuestion" -%}
        {{- "\"" + km.entities.answers[reply["value"]].label + "\"" + "," -}}
        {%- set answerUuid = reply["value"] -%}

        {%- set followUpUuids = km.entities.answers[answerUuid].followUpUuids -%}


        {%- for followUpUuid in followUpUuids -%}
            {%- set subQuestion = km.entities.questions[followUpUuid] -%}

            {{- replyPathUuids.append(answerUuid) or "" -}}
            {{- replyPathUuids.append(followUpUuid) or "" -}}

            {{- valuesOfQuestions(replyPathUuids, subQuestion) -}}

            {{- replyPathUuids.remove(answerUuid) or "" -}}
            {{- replyPathUuids.remove(followUpUuid) or "" -}}

        {%- endfor -%}
    {%- else -%}
        {{- "\"" + reply["value"] + "\"" + "," -}}
    {%- endif -%}

{%- endmacro -%}

{#- Body of the script -#}

{%- set km = ctx.knowledgeModel -%}
{%- set repliesMap = ctx.questionnaireReplies -%}

{%- set i = namespace(value = 1) -%}
{%- set lastChapterUuid = "7dd0abe3-0cb1-4bd8-9ece-35726e127963" -%}

{%- for chapterUuid in km.entities.chapters -%}

    {%- if chapterUuid != lastChapterUuid -%}
        {% set j = namespace(value = 1) %}
        {%- for questionUuid in km.entities.chapters[chapterUuid].questionUuids -%}

            {%- set question = km.entities.questions[questionUuid] -%}
            {{- markQuestions([chapterUuid, questionUuid], question, "q" + i.value | string + "." + j.value | string) -}}

            {%- set j.value = j.value + 1 -%}
        {%- endfor -%}
        {%- set i.value = i.value + 1 -%}
    {%- endif -%}
{%- endfor -%}

{%- set i.value = i.value + 1 -%}

{% set j = namespace(value = 1) %}
{%- for questionUuid in km.entities.chapters[lastChapterUuid].questionUuids -%}

    {%- set question = km.entities.questions[questionUuid] -%}
    {{- markQuestions([lastChapterUuid, questionUuid], question, "q" + i.value | string + "." + j.value | string) -}}

    {%- set j.value = j.value + 1 -%}
{%- endfor -%}

{{- "\n" -}}

{%- for chapterUuid in km.entities.chapters -%}
    {%- if chapterUuid != lastChapterUuid -%}
        {%- for questionUuid in km.entities.chapters[chapterUuid].questionUuids -%}
            {%- set question = km.entities.questions[questionUuid] -%}
            {{- valuesOfQuestions([chapterUuid, questionUuid], question) -}}
        {%- endfor -%}
    {%- endif -%}
{%- endfor -%}

{%- for questionUuid in km.entities.chapters[lastChapterUuid].questionUuids -%}
    {%- set question = km.entities.questions[questionUuid] -%}
    {{- valuesOfQuestions([lastChapterUuid, questionUuid], question) -}}
{%- endfor -%}